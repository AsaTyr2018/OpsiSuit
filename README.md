<div align="center">
  <h1>OpsiSuit</h1>
  <p><strong>Automate the installation, configuration, and day-2 operations of an OPSI landscape with one cohesive toolkit.</strong></p>
  <p>
    <a href="docs/requirements-installation.md"><img src="https://img.shields.io/badge/docs-requirements-blue" alt="Requirements"></a>
    <img src="https://img.shields.io/badge/status-early%20preview-orange" alt="Project status">
    <img src="https://img.shields.io/badge/platform-linux--only-informational" alt="Target platform">
  </p>
</div>

---

## Table of Contents
- [Overview](#overview)
- [Highlights](#highlights)
- [Roadmap & Progress](#roadmap--progress)
- [Repository Layout](#repository-layout)
- [Architecture](#architecture)
- [Prerequisites](#prerequisites)
- [Quick Start](#quick-start)
- [Configuration Guide](#configuration-guide)
- [Operational Notes](#operational-notes)
- [Contributing & Feedback](#contributing--feedback)
- [Additional Resources](#additional-resources)

## Overview
OpsiSuit bundles everything required to bootstrap an OPSI environment. It ships Docker Compose definitions, pre-built configuration templates, and an installer script that can set up the full stack â€” OPSI server, MariaDB, Redis, and PXE/TFTP â€” in a predictable and repeatable manner.

## Highlights
- **Container-first design:** Deploy every service through Docker Compose with sensible defaults and isolated volumes.
- **Guided installer:** `scripts/opsisuit-installer.sh` provisions configuration, validates prerequisites, and starts the stack with a single command.
- **Editable templates:** Example configuration files for OPSI, PXE/TFTP, and the client agent are copied locally and version controlled via `.gitignore` so you can iterate safely.
- **Secure-by-default defaults:** Critical ports, Redis connectivity, `opsiconfd` arguments, and a self-signed HTTPS certificate are pre-populated to avoid fragile setups.
- **Extensible foundation:** Additional services (monitoring, web frontends, inventory extensions) can be layered on top of the provided structure.
- **Automated inventory discovery:** A dedicated helper scans networks, registers new hosts via the ConfigAPI, and keeps report history for auditability.

## Roadmap & Progress
| Status | Milestone |
| --- | --- |
| âœ… | Repository skeleton with Docker Compose stack for OPSI server, MariaDB, Redis Stack, and netboot.xyz PXE service. |
| âœ… | Installer script capable of checking dependencies, preparing environment files, and optionally starting containers automatically. |
| âœ… | Sample configuration bundles for OPSI server, PXE/TFTP, and client agent including updated `OPSICONFD_ARGS` handling. |
| ðŸš§ | Documenting OPSI-specific secrets, credentials, and hardening guides. |
| ðŸš§ | Extending automation with monitoring hooks, inventory enhancements, and integration tests. |

## Repository Layout
```
.
â”œâ”€â”€ configs/                # Sample and target configurations
â”‚   â”œâ”€â”€ agent/
â”‚   â”œâ”€â”€ opsi/
â”‚   â””â”€â”€ pxe/
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ .env.example        # Example values for the compose stack
â”‚   â””â”€â”€ docker-compose.yml
â”œâ”€â”€ docs/                   # Additional documentation
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ opsisuit-installer.sh
â””â”€â”€ README.md
```
Configuration files without the `.example` suffix are generated by the installer and are ignored via `.gitignore` to keep secrets out of version control.

## Architecture
| Service | Description |
| --- | --- |
| `db` | MariaDB 10.11 serves as the central OPSI datastore. |
| `redis` | Redis Stack (including RedisTimeSeries) is used for caching and metrics. |
| `opsi-server` | Containerised OPSI server exposing the Config API and depot services. |
| `pxe` | netboot.xyz TFTP/HTTP service with a lightweight web UI for OS images. |

## Prerequisites
- Linux host (Debian/Ubuntu, RHEL/CentOS/Rocky, openSUSE, or Arch/Manjaro).
- Docker and Docker Compose plugin (or standalone `docker-compose`).
- `curl` and `git`.

**Quick installation (Debian/Ubuntu):**
```bash
sudo apt update
sudo apt install -y docker.io docker-compose-plugin curl git
sudo systemctl enable --now docker
sudo usermod -aG docker "$USER"
```
> After adding yourself to the `docker` group you need a new terminal session so that the permissions take effect.

## Quick Start
```bash
# Discover available options
./scripts/opsisuit-installer.sh --help

# Full unattended installation (installs dependencies, prepares configs, starts stack)
sudo ./scripts/opsisuit-installer.sh --auto-install-deps

# Prepare configuration files without starting containers
./scripts/opsisuit-installer.sh --skip-start

# Perform a dry run with no side effects
./scripts/opsisuit-installer.sh --dry-run

# Execute a discovery-only network inventory scan
./scripts/inventory-discovery.py --dry-run --verbose
```

### Automated Inventory Discovery
`scripts/inventory-discovery.py` performs a concurrent ping sweep across the configured subnets, enriches reachable hosts with DNS/MAC metadata, and can directly register missing clients via the OPSI ConfigAPI. Reports are persisted to `data/inventory/` so you can track historic changes.

Key behaviours:

- **Configuration first:** Adjust `configs/inventory/auto-inventory.yml` (copied from the `.example` file by the installer) to define subnets, exclusions, worker limits, and API credentials. The file uses YAML in JSON-compatible syntax so it also works with minimal tooling.
- **Safe dry runs:** Run with `--dry-run` (default in the example above) to validate connectivity without writing output or touching the server.
- **OPSI integration:** When `registration.auto_register` is set to `true` the helper uses HTTPS JSON-RPC calls to create missing clients and queue an `auditHardware` action, ensuring newly discovered endpoints run a hardware inventory once the agent is active.
- **Scheduling:** Add the script to `cron` or a `systemd` timer for recurring scans, e.g. nightly discovery of unregistered devices.
The installer executes the following steps:
1. Creates required directories (`data/`, `logs/`, `backups/`, `configs/`).
2. Copies `.example` files to editable templates.
3. Checks and optionally installs dependencies.
4. Starts the Docker Compose stack (`docker compose up -d`).

Use `--force-env` or `--force-config` to overwrite existing `.env` or configuration files.

### Rollback & Reset

```bash
# Preview cleanup steps without executing them
./scripts/opsisuit-rollback.sh --dry-run

# Fully remove containers, data, and generated configuration
./scripts/opsisuit-rollback.sh --yes
```
The rollback script stops all OpsiSuit containers, removes generated configuration files (keeping the `.example` templates), and clears `data/`, `logs/`, `backups/`, and `tmp/` so that you can start again from a pristine example state.

## Configuration Guide
1. **`docker/.env`** â€“ Contains ports, passwords, image tags, and secrets. The installer pre-populates `OPSICONFD_ARGS` with `--config-file=/etc/opsi/opsiconfd.conf` so that `opsiconfd` reads the rendered configuration instead of relying on the deprecated `--ssl` flag.
2. **`configs/opsi/opsi.conf`** â€“ Global OPSI settings. Copy additional snippets into `data/opsi/etc/conf.d/` once generated.
3. **`configs/pxe/pxe.conf`** â€“ Sample configuration for dnsmasq/TFTP.
4. **`configs/agent/client-agent.conf`** â€“ Template for the OPSI client agent (place into `data/opsi/etc/agent.d/`).
5. **`configs/inventory/auto-inventory.yml`** â€“ Defines subnets, exclusions, OPSI credentials, and behaviour for the automated discovery helper (`scripts/inventory-discovery.py`).

## Operational Notes
> **Persistent data:** When the OPSI server container starts it relocates `/etc/opsi`, `/var/lib/opsi`, `/var/log/opsi`, and `/var/lib/opsiconfd` into `/data` (exposed as `data/opsi/` on the host). Logs live under `data/opsi/log/`.

> **PXE container user:** `SERVICE_UID`/`SERVICE_GID` must reference a real host user/group (default `1000`) to avoid `Invalid user name nbxyz` during PXE startup.

> **Networking defaults:** Internal communication ports such as `OPSI_API_PORT`, `OPSI_DEPOT_PORT`, `PXE_TFTP_PORT`, and `REDIS_SERVICE_PORT` are pinned to stable defaults within `.env`. The Redis connection for `opsiconfd` (`OPSICONFD_REDIS_URL`) is fixed to `redis://redis:${REDIS_SERVICE_PORT:-6379}/0`.

> **Host naming:** Set `OPSI_SERVER_FQDN` in `.env` to a fully qualified domain name (e.g., `opsi.example.local`). `opsiconfd` rejects non-FQDN hostnames with `ValueError: Bad fqdn`.

## Contributing & Feedback
We are actively iterating on deployment hardening, monitoring integrations, and automated testing. Feel free to open issues or pull requests with ideas, bug reports, or enhancements.

## Additional Resources
- [Installation requirements and distribution notes](docs/requirements-installation.md)
- OPSI documentation: [https://docs.opsi.org](https://docs.opsi.org)
